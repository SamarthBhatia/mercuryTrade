name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        asan_options: ["detect_leaks=1", ""]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v3

    - name: Log System Information
      run: |
        uname -a
        g++ --version
        cmake --version

    - name: Install dependencies
      run: |
        if [[ "$(uname -s)" == "Darwin" ]]; then
          brew install cmake
        else
          sudo apt-get update
          sudo apt-get install -y cmake g++-12 build-essential
        fi

    - name: Create Build Directory
      run: mkdir build

    - name: Configure CMake
      run: |
        cd build
        if [[ "$(uname -s)" == "Darwin" ]]; then
          cmake -DCMAKE_BUILD_TYPE=Debug ..
        else
          cmake -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer" -DCMAKE_BUILD_TYPE=Debug ..
        fi

    - name: Build
      run: |
        cd build
        cmake --build . --config Debug

    - name: Run Tests
      env:
        ASAN_OPTIONS: ${{ matrix.asan_options }}
      run: |
        cd build
        ctest --output-on-failure || ctest --rerun-failed --output-on-failure

